{% extends "_base.html" %}

{% block title %}企業一覧 - フォーム管理{% endblock %}

{% block content %}
<div class="user-greeting">
  <p>こんにちは、<strong>{{ current_user.id }}</strong> さん！</p>
</div>

<div class="keywords-display">
  <p>🔍 <strong>Bing検索キーワード:</strong> 「{{ active_keywords | join(' ') }} 概要 情報 -一覧 -ランキング -まとめ -比較」</p>
</div>

<h1>🏢 企業一覧</h1>

<!-- フィルターフォーム -->
<div class="filter-box mb-4">
  <form id="filter-form" class="row g-2">
    <div class="col-md-4">
      <input type="text" class="form-control" placeholder="企業名でフィルター" id="filter-name">
    </div>
    <div class="col-md-4">
      <input type="text" class="form-control" placeholder="住所でフィルター" id="filter-address">
    </div>
    <div class="col-md-4">
      <input type="text" class="form-control" placeholder="カテゴリでフィルター" id="filter-category">
    </div>
  </form>
</div>

<div class="table-container">
  <table class="table">
    <thead>
      <tr>
        <th>操作</th>
        <th>企業名</th>
        <th>トップページ</th>
        <th>問い合わせ</th>
        <th>住所</th>
        <th>電話番号</th>
        <th>FAX</th>
        <th>カテゴリ</th>
        <th>説明</th>
      </tr>
    </thead>
    <tbody>
      {% for f in forms %}
      <tr>
        <td>
          <a href="#"
            class="edit-btn btn btn-outline-primary btn-sm"
            data-id="{{ f['_id'] }}"
            data-name="{{ f.get('company_name', '') }}"
            data-address="{{ f.get('address', '') }}"
            data-tel="{{ f.get('tel', '') }}"
            data-fax="{{ f.get('fax', '') }}"
            data-category="{{ f.get('category_keywords', '') }}"
            data-description="{{ f.get('description', '') }}"
            data-bs-toggle="modal"
            data-bs-target="#editModal">✏️</a>
          <a href="{{ url_for('delete_company', company_id=f['_id']) }}"
            onclick="return confirm('この企業データを削除してよろしいですか？');"
            class="btn btn-outline-danger btn-sm">🗑️</a>
        </td>
        <td class="company-name">{{ f.get("company_name", "未設定") }}</td>
        <td>
          {% if f.get('url_top') and f.get('url_top') != '#' %}
            <a href="{{ f['url_top'] }}" target="_blank">🌐 サイトを開く</a>
          {% else %}
            <span class="empty-data">未設定</span>
          {% endif %}
        </td>
        <td>
          {% if f.get('url_form') and f.get('url_form') != '#' %}
            <a href="{{ f['url_form'] }}" target="_blank">📝 フォームを開く</a>
          {% else %}
            <span class="empty-data">未設定</span>
          {% endif %}
        </td>
        <td>{{ f.get("address", "未設定") }}</td>
        <td>{{ f.get("tel", "未設定") }}</td>
        <td>{{ f.get("fax", "未設定") }}</td>
        <td class="category-tag">{{ f.get("category_keywords", "未設定") }}</td>
        <td>{{ f.get("description", "未設定") }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- 編集モーダル -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form method="POST" action="/update_company">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">✏️ 企業情報を編集</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="company_id" id="edit_id">
          <div class="mb-2"><label>企業名: <input type="text" class="form-control" name="company_name" id="edit_name"></label></div>
          <div class="mb-2"><label>住所: <input type="text" class="form-control" name="address" id="edit_address"></label></div>
          <div class="mb-2"><label>電話番号: <input type="text" class="form-control" name="tel" id="edit_tel"></label></div>
          <div class="mb-2"><label>FAX: <input type="text" class="form-control" name="fax" id="edit_fax"></label></div>
          <div class="mb-2"><label>カテゴリ: <input type="text" class="form-control" name="category_keywords" id="edit_category"></label></div>
          <div class="mb-2"><label>説明: <textarea class="form-control" name="description" id="edit_description"></textarea></label></div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">保存</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
        </div>
      </div>
    </form>
  </div>
</div>

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const nameInput = document.getElementById("filter-name");
    const addressInput = document.getElementById("filter-address");
    const categoryInput = document.getElementById("filter-category");
    const rows = document.querySelectorAll("table tbody tr");

    function filterTable() {
      const nameFilter = nameInput.value.toLowerCase();
      const addressFilter = addressInput.value.toLowerCase();
      const categoryFilter = categoryInput.value.toLowerCase();

      rows.forEach(row => {
        const name = row.querySelector(".company-name")?.textContent.toLowerCase() || "";
        const address = row.cells[4]?.textContent.toLowerCase() || "";
        const category = row.querySelector(".category-tag")?.textContent.toLowerCase() || "";

        const matchName = name.includes(nameFilter);
        const matchAddress = address.includes(addressFilter);
        const matchCategory = category.includes(categoryFilter);

        if (matchName && matchAddress && matchCategory) {
          row.style.display = "";
        } else {
          row.style.display = "none";
        }
      });
    }

    nameInput.addEventListener("input", filterTable);
    addressInput.addEventListener("input", filterTable);
    categoryInput.addEventListener("input", filterTable);
  });
</script>
{% endblock %}
{% endblock %}
