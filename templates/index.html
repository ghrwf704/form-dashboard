{% extends "_base.html" %}

{% block title %}ä¼æ¥­ä¸€è¦§ - ãƒ•ã‚©ãƒ¼ãƒ ç®¡ç†{% endblock %}

{% block content %}
<div class="user-greeting">
  <p>ã“ã‚“ã«ã¡ã¯ã€<strong>{{ current_user.id }}</strong> ã•ã‚“ï¼</p>
</div>

<div class="keywords-display">
  <p>ğŸ” <strong>Bingæ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰:</strong> ã€Œ{{ active_keywords | join(' ') }} æ¦‚è¦ æƒ…å ± -ä¸€è¦§ -ãƒ©ãƒ³ã‚­ãƒ³ã‚° -ã¾ã¨ã‚ -æ¯”è¼ƒã€</p>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h1>ğŸ¢ ä¼æ¥­ä¸€è¦§</h1>
  <!-- è¡¨ç¤ºä¸­ãƒ‡ãƒ¼ã‚¿ã ã‘ã‚’Excelå‡ºåŠ›ã™ã‚‹ãƒœã‚¿ãƒ³ -->
  <button id="exportVisible" class="btn btn-success">è¡¨ç¤ºä¸­ãƒ‡ãƒ¼ã‚¿ã‚’Excelå‡ºåŠ›</button>
</div>

<!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ•ã‚©ãƒ¼ãƒ  -->
<div class="filter-box mb-4">
  <form id="filter-form" class="row g-2">
    <div class="col-md-3">
      <input type="text" class="form-control" placeholder="ä¼æ¥­åã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼" id="filter-name">
    </div>
    <div class="col-md-3">
      <input type="text" class="form-control" placeholder="ä½æ‰€ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼" id="filter-address">
    </div>
    <div class="col-md-3">
      <select class="form-control" id="filter-status">
        <option value="">å–¶æ¥­ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</option>
        <option value="æœªé€£çµ¡">æœªé€£çµ¡</option>
        <option value="é€£çµ¡æ¸ˆ">é€£çµ¡æ¸ˆ</option>
        <option value="ä¿ç•™">ä¿ç•™</option>
      </select>
    </div>
  </form>
</div>

<div class="table-container">
  <table class="table">
    <thead class="sticky-header">
      <tr>
        <th>æ“ä½œ</th>
        <th>ä¼æ¥­å</th>
        <th>ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸</th>
        <th>å•ã„åˆã‚ã›</th>
        <th>ä½æ‰€</th>
        <th>é›»è©±ç•ªå·</th>
        <th>FAX</th>
        <th>å–¶æ¥­ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
        <th>å¾“æ¥­å“¡æ•°</th>
        <th>è³‡æœ¬é‡‘</th>
        <th>è¨­ç«‹å¹´æœˆ</th>
        <th>ä»£è¡¨å–ç· å½¹</th>
        <th>ãƒ¡ãƒ¼ãƒ«</th>
      </tr>
    </thead>
    <tbody>
      {% for f in forms %}
      <tr>
        <td>
          <a href="#" class="edit-btn btn btn-outline-primary btn-sm"
             data-id="{{ f['_id'] }}"
             data-company-name="{{ f.get('company_name', '') | e }}"
             data-url-top="{{ f.get('url_top', '') | e }}"
             data-url-form="{{ f.get('url_form', '') | e }}"
             data-address="{{ f.get('address', '') | e }}"
             data-tel="{{ f.get('tel', '') | e }}"
             data-fax="{{ f.get('fax', '') | e }}"
             data-category="{{ f.get('category_keywords', '') | e }}"
             data-description="{{ f.get('description', '') | e }}"
             data-sales-status="{{ f.get('sales_status', 'æœªé€£çµ¡') | e }}"
             data-sales-note="{{ f.get('sales_note', '') | e }}"
             data-bs-toggle="modal" data-bs-target="#editModal">âœï¸</a>
          <a href="{{ url_for('delete_company', company_id=f['_id']) }}"
             onclick="return confirm('ã“ã®ä¼æ¥­ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ');"
             class="btn btn-outline-danger btn-sm">
             ğŸ—‘ï¸
          </a>
          <button class="toggle-details btn btn-sm btn-outline-secondary">
            <span class="toggle-icon">â–¼</span>
          </button>
        </td>
        <td class="company-name">{{ f.get("company_name", "æœªè¨­å®š") }}</td>
        <td>
          {% if f.get('url_top') and f.get('url_top') != '#' %}
            <a href="{{ f['url_top'] }}" target="_blank">
              {% if f.get('eyecatch_image') %}
                <img src="{{ f['eyecatch_image'].replace('http://', 'https://') }}" alt="ã‚¢ã‚¤ã‚­ãƒ£ãƒƒãƒ" class="eyecatch-img"/>
              {% else %}
                ğŸŒ ã‚µã‚¤ãƒˆã‚’é–‹ã
              {% endif %}
            </a>
          {% else %}
            <span class="empty-data">æœªè¨­å®š</span>
          {% endif %}
        </td>
        <td>
          {% if f.get('url_form') and f.get('url_form') != '#' %}
            <a href="{{ f['url_form'] }}" target="_blank">ğŸ“ ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã</a>
          {% else %}
            <span class="empty-data">æœªè¨­å®š</span>
          {% endif %}
        </td>
        <td>{{ f.get("address", "æœªè¨­å®š") }}</td>
        <td>{{ f.get("tel", "æœªè¨­å®š") }}</td>
        <td>{{ f.get("fax", "æœªè¨­å®š") }}</td>
        <td class="sales-status">{{ f.get("sales_status", "æœªé€£çµ¡") }}</td>
        <td>{{ f.get("employees", "ä¸æ˜") }}</td>
        <td>{{ f.get("capital", "ä¸æ˜") }}</td>
        <td>{{ f.get("founded", "ä¸æ˜") }}</td>
        <td>{{ f.get("ceo", "ä¸æ˜") }}</td>
        <td>{{ f.get("email", "æœªç™»éŒ²") }}</td>
        <!-- ã‚«ãƒ†ã‚´ãƒª -->
      <tr class="detail-row" style="display: none;">
        <td colspan="16" class="company-details-row">
          <div class="detail-inline">
            <span><strong>ã‚«ãƒ†ã‚´ãƒª:</strong> {{ f.get("category_keywords", "ãªã—") }}</span><br>
            <span><strong>èª¬æ˜:</strong> {{ f.get("description", "ãªã—") }}</span><br>
            <span><strong>ãƒ¡ãƒ¢:</strong> {{ f.get("sales_note", "ãªã—") }}</span>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form method="POST" action="/update_company">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">âœï¸ ä¼æ¥­æƒ…å ±ã‚’ç·¨é›†</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="company_id" id="edit_id">
          <div class="mb-2"><label>ä¼æ¥­å: <input type="text" class="form-control" name="company_name" id="edit_name"></label></div>
          <!-- URLãƒˆãƒƒãƒ— -->
          <div class="mb-3">
            <label for="edit-url-top" class="form-label">ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸URL</label>
            <input type="text" class="form-control" id="edit-url-top" name="url_top">
          </div>
          <div class="mb-3">
            <label for="edit-url-form" class="form-label">ãƒ•ã‚©ãƒ¼ãƒ URL</label>
            <input type="text" class="form-control" id="edit-url-form" name="url_form">
          </div>
          <div class="mb-2"><label>ä½æ‰€: <input type="text" class="form-control" name="address" id="edit_address"></label></div>
          <div class="mb-2"><label>é›»è©±ç•ªå·: <input type="text" class="form-control" name="tel" id="edit_tel"></label></div>
          <div class="mb-2"><label>FAX: <input type="text" class="form-control" name="fax" id="edit_fax"></label></div>
          <div class="mb-2"><label>ã‚«ãƒ†ã‚´ãƒª: <input type="text" class="form-control" name="category_keywords" id="edit_category"></label></div>
          <div class="mb-2"><label>èª¬æ˜: <textarea class="form-control" name="description" id="edit_description"></textarea></label></div>
          <div class="mb-2"><label>å–¶æ¥­ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:
            <select class="form-control" name="sales_status" id="edit_status">
              <option value="æœªé€£çµ¡">æœªé€£çµ¡</option>
              <option value="é€£çµ¡æ¸ˆ">é€£çµ¡æ¸ˆ</option>
              <option value="ä¿ç•™">ä¿ç•™</option>
            </select>
          </label></div>
          <div class="mb-2"><label>ãƒ¡ãƒ¢: <textarea class="form-control" name="sales_note" id="edit_note"></textarea></label></div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">ä¿å­˜</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
        </div>
      </div>
    </form>
  </div>
</div>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const nameInput = document.getElementById("filter-name");
    const addressInput = document.getElementById("filter-address");
    const statusSelect = document.getElementById("filter-status");
    const rows = document.querySelectorAll("table tbody tr");

    function filterTable() {
      const nameFilter = nameInput.value.toLowerCase();
      const addressFilter = addressInput.value.toLowerCase();
      const statusFilter = statusSelect.value;

      rows.forEach(row => {
        const name = row.querySelector(".company-name")?.textContent.toLowerCase() || "";
        const address = row.cells[4]?.textContent.toLowerCase() || "";
        const status = row.querySelector(".sales-status")?.textContent || "";

        const matchName = name.includes(nameFilter);
        const matchAddress = address.includes(addressFilter);
        const matchStatus = !statusFilter || status === statusFilter;

        row.style.display = (matchName && matchAddress && matchCategory && matchStatus) ? "" : "none";
      });
    }

    nameInput.addEventListener("input", filterTable);
    addressInput.addEventListener("input", filterTable);
    statusSelect.addEventListener("change", filterTable);

    // Excelå‡ºåŠ›
    const exportBtn = document.getElementById("exportVisible");
    exportBtn.addEventListener("click", () => {
      const name = nameInput.value.trim();
      const address = addressInput.value.trim();
      const status = statusSelect.value.trim();

      fetch("/export_excel_filtered", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, address, category, status })
      })
      .then(res => res.blob())
      .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "filtered_companies.xlsx";
        a.click();
      });
    });

    // ç·¨é›†ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
    document.querySelectorAll('.edit-btn').forEach(button => {
      document.addEventListener('click', function (e) {
      const button = e.target.closest('.edit-btn');
      if (!button) return; // edit-btnã§ãªã„ã‚¯ãƒªãƒƒã‚¯ç„¡è¦–

      const name = button.dataset.companyName;
      document.getElementById('edit_id').value = button.dataset.id || '';
      document.getElementById('edit_name').value = name && name !== 'None' ? name : '';
      document.getElementById('edit-url-top').value = button.dataset.urlTop || '';
      document.getElementById('edit-url-form').value = button.dataset.urlForm || '';
      document.getElementById('edit_address').value = button.dataset.address || '';
      document.getElementById('edit_tel').value = button.dataset.tel || '';
      document.getElementById('edit_fax').value = button.dataset.fax || '';
      document.getElementById('edit_category').value = button.dataset.category || '';
      document.getElementById('edit_description').value = button.dataset.description || '';
      document.getElementById('edit_status').value = button.dataset.salesStatus || 'æœªé€£çµ¡';
      document.getElementById('edit_note').value = button.dataset.salesNote || '';
    });
    });
  });
  document.querySelectorAll('.toggle-details').forEach(btn => {
    btn.addEventListener("click", () => {
      const row = btn.closest("tr");
      const detailRow = row.nextElementSibling;
      const icon = btn.querySelector(".toggle-icon");

      if (detailRow && detailRow.classList.contains("detail-row")) {
        const isVisible = detailRow.style.display !== "none";
        detailRow.style.display = isVisible ? "none" : "table-row";
        icon.textContent = isVisible ? "â–¼" : "â–²";
      }
    });
  });
</script>
{% endblock %}

