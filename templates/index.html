{% extends "_base.html" %}

{% block title %}企業一覧 - フォーム管理{% endblock %}

{% block content %}
<div class="user-greeting">
  <p>こんにちは、<strong>{{ current_user.id }}</strong> さん！</p>
</div>

<div class="keywords-display">
  <p>🔍 <strong>Bing検索キーワード:</strong> 「{{ active_keywords | join(' ') }} 概要 情報 -一覧 -ランキング -まとめ -比較」</p>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h1>🏢 企業一覧</h1>
  <!-- 表示中データだけをExcel出力するボタン -->
  <button id="exportVisible" class="btn btn-success">表示中データをExcel出力</button>
</div>

<!-- フィルターフォーム -->
<div class="filter-box mb-4">
  <form id="filter-form" class="row g-2">
    <div class="col-md-3">
      <input type="text" class="form-control" placeholder="企業名でフィルター" id="filter-name">
    </div>
    <div class="col-md-3">
      <input type="text" class="form-control" placeholder="住所でフィルター" id="filter-address">
    </div>
    <div class="col-md-3">
      <input type="text" class="form-control" placeholder="カテゴリでフィルター" id="filter-category">
    </div>
    <div class="col-md-3">
      <select class="form-control" id="filter-status">
        <option value="">営業ステータスでフィルター</option>
        <option value="未連絡">未連絡</option>
        <option value="連絡済">連絡済</option>
        <option value="保留">保留</option>
      </select>
    </div>
  </form>
</div>

<div class="table-container">
  <table class="table">
    <thead class="sticky-header">
      <tr>
        <th>操作</th>
        <th>企業名</th>
        <th>トップページ</th>
        <th>問い合わせ</th>
        <th>住所</th>
        <th>電話番号</th>
        <th>FAX</th>
        <th>営業ステータス</th>
        <th>従業員数</th>
        <th>資本金</th>
        <th>設立年月</th>
        <th>代表取締役</th>
        <th>メール</th>
        <th>🔍</th>  <!-- カテゴリ -->
        <th>📝</th>  <!-- 説明 -->
        <th>🗒️</th> <!-- メモ -->                
      </tr>
    </thead>
    <tbody>
      {% for f in forms %}
      <tr>
        <td>
          <a href="#" class="edit-btn btn btn-outline-primary btn-sm"
             data-id="{{ f['_id'] }}"
             data-company-name="{{ f.get('company_name', '') | e }}"
             data-url-top="{{ f.get('url_top', '') | e }}"
             data-url-form="{{ f.get('url_form', '') | e }}"
             data-address="{{ f.get('address', '') | e }}"
             data-tel="{{ f.get('tel', '') | e }}"
             data-fax="{{ f.get('fax', '') | e }}"
             data-category="{{ f.get('category_keywords', '') | e }}"
             data-description="{{ f.get('description', '') | e }}"
             data-sales-status="{{ f.get('sales_status', '未連絡') | e }}"
             data-sales-note="{{ f.get('sales_note', '') | e }}"
             data-bs-toggle="modal" data-bs-target="#editModal">✏️</a>
          <a href="{{ url_for('delete_company', company_id=f['_id']) }}"
             onclick="return confirm('この企業データを削除してよろしいですか？');"
             class="btn btn-outline-danger btn-sm">
             🗑️
          </a>
          <button class="toggle-details btn btn-sm btn-outline-secondary">
            <span class="toggle-icon">▼</span>
          </button>
        </td>
        <td class="company-name">{{ f.get("company_name", "未設定") }}</td>
        <td>
          {% if f.get('url_top') and f.get('url_top') != '#' %}
            <a href="{{ f['url_top'] }}" target="_blank">
              {% if f.get('eyecatch_image') %}
                <img src="{{ f['eyecatch_image'].replace('http://', 'https://') }}" alt="アイキャッチ" class="eyecatch-img"/>
              {% else %}
                🌐 サイトを開く
              {% endif %}
            </a>
          {% else %}
            <span class="empty-data">未設定</span>
          {% endif %}
        </td>
        <td>
          {% if f.get('url_form') and f.get('url_form') != '#' %}
            <a href="{{ f['url_form'] }}" target="_blank">📝 フォームを開く</a>
          {% else %}
            <span class="empty-data">未設定</span>
          {% endif %}
        </td>
        <td>{{ f.get("address", "未設定") }}</td>
        <td>{{ f.get("tel", "未設定") }}</td>
        <td>{{ f.get("fax", "未設定") }}</td>
        <td class="sales-status">{{ f.get("sales_status", "未連絡") }}</td>
        <td>{{ f.get("employees", "不明") }}</td>
        <td>{{ f.get("capital", "不明") }}</td>
        <td>{{ f.get("founded", "不明") }}</td>
        <td>{{ f.get("ceo", "不明") }}</td>
        <td>{{ f.get("email", "未登録") }}</td>
        <!-- カテゴリ -->
        <td>
          <span class="hover-tooltip">🔍
            <span class="tooltip-text">{{ f.get("category_keywords") or "なし" }}</span>
          </span><br>
        </td>
        <!-- 説明 -->
        <td>
          <span class="hover-tooltip">📝
            <span class="tooltip-text">{{ f.get("description") or "なし" }}</span>
          </span><br>
        </td>
        <!-- メモ -->
        <td>
          <span class="hover-tooltip">🗒️
            <span class="tooltip-text">{{ f.get("sales_note") or "なし" }}</span>
          </span>
        </td>
      </tr>
      <tr class="detail-row" style="display: none;">
        <td colspan="11" class="company-details-row">
          <div class="detail-inline">
            <span><strong>カテゴリ:</strong> {{ f.get("category_keywords", "なし") }}</span>
            <span><strong>説明:</strong> {{ f.get("description", "なし") }}</span>
            <span><strong>メモ:</strong> {{ f.get("sales_note", "なし") }}</span>
          </div>
        </td>
      </tr>     
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- 編集モーダル -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form method="POST" action="/update_company">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">✏️ 企業情報を編集</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="company_id" id="edit_id">
          <div class="mb-2"><label>企業名: <input type="text" class="form-control" name="company_name" id="edit_name"></label></div>
          <!-- URLトップ -->
          <div class="mb-3">
            <label for="edit-url-top" class="form-label">トップページURL</label>
            <input type="text" class="form-control" id="edit-url-top" name="url_top">
          </div>
          <div class="mb-3">
            <label for="edit-url-form" class="form-label">フォームURL</label>
            <input type="text" class="form-control" id="edit-url-form" name="url_form">
          </div>
          <div class="mb-2"><label>住所: <input type="text" class="form-control" name="address" id="edit_address"></label></div>
          <div class="mb-2"><label>電話番号: <input type="text" class="form-control" name="tel" id="edit_tel"></label></div>
          <div class="mb-2"><label>FAX: <input type="text" class="form-control" name="fax" id="edit_fax"></label></div>
          <div class="mb-2"><label>カテゴリ: <input type="text" class="form-control" name="category_keywords" id="edit_category"></label></div>
          <div class="mb-2"><label>説明: <textarea class="form-control" name="description" id="edit_description"></textarea></label></div>
          <div class="mb-2"><label>営業ステータス:
            <select class="form-control" name="sales_status" id="edit_status">
              <option value="未連絡">未連絡</option>
              <option value="連絡済">連絡済</option>
              <option value="保留">保留</option>
            </select>
          </label></div>
          <div class="mb-2"><label>メモ: <textarea class="form-control" name="sales_note" id="edit_note"></textarea></label></div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">保存</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
        </div>
      </div>
    </form>
  </div>
</div>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const nameInput = document.getElementById("filter-name");
    const addressInput = document.getElementById("filter-address");
    const categoryInput = document.getElementById("filter-category");
    const statusSelect = document.getElementById("filter-status");
    const rows = document.querySelectorAll("table tbody tr");

    function filterTable() {
      const nameFilter = nameInput.value.toLowerCase();
      const addressFilter = addressInput.value.toLowerCase();
      const categoryFilter = categoryInput.value.toLowerCase();
      const statusFilter = statusSelect.value;

      rows.forEach(row => {
        const name = row.querySelector(".company-name")?.textContent.toLowerCase() || "";
        const address = row.cells[4]?.textContent.toLowerCase() || "";
        const category = row.querySelector(".category-tag")?.textContent.toLowerCase() || "";
        const status = row.querySelector(".sales-status")?.textContent || "";

        const matchName = name.includes(nameFilter);
        const matchAddress = address.includes(addressFilter);
        const matchCategory = category.includes(categoryFilter);
        const matchStatus = !statusFilter || status === statusFilter;

        row.style.display = (matchName && matchAddress && matchCategory && matchStatus) ? "" : "none";
      });
    }

    nameInput.addEventListener("input", filterTable);
    addressInput.addEventListener("input", filterTable);
    categoryInput.addEventListener("input", filterTable);
    statusSelect.addEventListener("change", filterTable);

    // Excel出力
    const exportBtn = document.getElementById("exportVisible");
    exportBtn.addEventListener("click", () => {
      const name = nameInput.value.trim();
      const address = addressInput.value.trim();
      const category = categoryInput.value.trim();
      const status = statusSelect.value.trim();

      fetch("/export_excel_filtered", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, address, category, status })
      })
      .then(res => res.blob())
      .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "filtered_companies.xlsx";
        a.click();
      });
    });

    // 編集ボタンクリック時の処理
    document.querySelectorAll('.edit-btn').forEach(button => {
      document.addEventListener('click', function (e) {
      const button = e.target.closest('.edit-btn');
      if (!button) return; // edit-btnでないクリック無視

      const name = button.dataset.companyName;
      document.getElementById('edit_id').value = button.dataset.id || '';
      document.getElementById('edit_name').value = name && name !== 'None' ? name : '';
      document.getElementById('edit-url-top').value = button.dataset.urlTop || '';
      document.getElementById('edit-url-form').value = button.dataset.urlForm || '';
      document.getElementById('edit_address').value = button.dataset.address || '';
      document.getElementById('edit_tel').value = button.dataset.tel || '';
      document.getElementById('edit_fax').value = button.dataset.fax || '';
      document.getElementById('edit_category').value = button.dataset.category || '';
      document.getElementById('edit_description').value = button.dataset.description || '';
      document.getElementById('edit_status').value = button.dataset.salesStatus || '未連絡';
      document.getElementById('edit_note').value = button.dataset.salesNote || '';
    });
    });
  });
  document.querySelectorAll('.toggle-details').forEach(btn => {
    btn.addEventListener("click", () => {
      const row = btn.closest("tr");
      const detailRow = row.nextElementSibling;
      const icon = btn.querySelector(".toggle-icon");

      if (detailRow && detailRow.classList.contains("detail-row")) {
        const isVisible = detailRow.style.display !== "none";
        detailRow.style.display = isVisible ? "none" : "table-row";
        icon.textContent = isVisible ? "▼" : "▲";
      }
    });
  });
</script>
{% endblock %}

