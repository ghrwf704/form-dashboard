{% extends "_base.html" %}

{% block title %}企業一覧 - フォーム管理{% endblock %}

{% block content %}
<div class="user-greeting">
  <p>こんにちは、<strong>{{ current_user.id }}</strong> さん！</p>
</div>

<div class="keywords-display">
  <p>🔍 <strong>Bing検索キーワード:</strong> 「{{ active_keywords | join(' ') }} 概要 情報 -一覧 -ランキング -まとめ -比較」</p>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h1>🏢 企業一覧</h1>
<!-- 表示中データだけをExcel出力するボタン -->
<button id="exportVisible" style="margin-top: 10px;">表示中データをExcel出力</button>

<script>
    document.getElementById("exportVisible").addEventListener("click", () => {
        const rows = Array.from(document.querySelectorAll("table tbody tr"));
        const data = rows.map(row => {
            const cells = row.querySelectorAll("td");
            return {
                company_name: cells[1]?.textContent.trim(),
                url_top: cells[2]?.textContent.trim(),
                url_form: cells[3]?.textContent.trim(),
                address: cells[4]?.textContent.trim(),
                tel: cells[5]?.textContent.trim(),
                fax: cells[6]?.textContent.trim(),
                category_keywords: cells[7]?.textContent.trim(),
                description: cells[8]?.textContent.trim(),
                sales_status: cells[9]?.textContent.trim(),
                sales_note: cells[10]?.textContent.trim()
            };
        });

        fetch("/export_excel_from_view", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ rows: data })
        })
        .then(res => res.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "filtered_companies.xlsx";
            a.click();
        });
    });
</script>
</div>

<!-- フィルターフォーム -->
<div class="filter-box mb-4">
  <form id="filter-form" class="row g-2">
    <div class="col-md-3">
      <input type="text" class="form-control" placeholder="企業名でフィルター" id="filter-name">
    </div>
    <div class="col-md-3">
      <input type="text" class="form-control" placeholder="住所でフィルター" id="filter-address">
    </div>
    <div class="col-md-3">
      <input type="text" class="form-control" placeholder="カテゴリでフィルター" id="filter-category">
    </div>
    <div class="col-md-3">
      <select class="form-control" id="filter-status">
        <option value="">営業ステータスでフィルター</option>
        <option value="未連絡">未連絡</option>
        <option value="連絡済">連絡済</option>
        <option value="保留">保留</option>
      </select>
    </div>
  </form>
</div>

<div class="table-container" style="overflow-x: auto; max-height: 70vh;">
  <table class="table" style="table-layout: fixed;">
    <thead style="position: sticky; top: 0; background: white; z-index: 2;">
      <tr>
        <th>操作</th>
        <th>企業名</th>
        <th>トップページ</th>
        <th>問い合わせ</th>
        <th>住所</th>
        <th>電話番号</th>
        <th>FAX</th>
        <th>カテゴリ</th>
        <th>説明</th>
        <th>営業ステータス</th>
        <th>営業メモ</th>
      </tr>
    </thead>
    <tbody>
      {% for f in forms %}
      <tr>
        <td>
          <a href="#"
            class="edit-btn btn btn-outline-primary btn-sm"
            data-id="{{ f['_id'] }}"
            data-name="{{ f.get('company_name', '') }}"
            data-address="{{ f.get('address', '') }}"
            data-tel="{{ f.get('tel', '') }}"
            data-fax="{{ f.get('fax', '') }}"
            data-category="{{ f.get('category_keywords', '') }}"
            data-description="{{ f.get('description', '') }}"
            data-url-top="{{ f.get('url_top', '') }}"
            data-url-form="{{ f.get('url_form', '') }}"
            data-status="{{ f.get('sales_status', '未連絡') }}"
            data-note="{{ f.get('sales_note', '') }}"
            data-bs-toggle="modal"
            data-bs-target="#editModal">✏️</a>
          <a href="{{ url_for('delete_company', company_id=f['_id']) }}"
            onclick="return confirm('この企業データを削除してよろしいですか？');"
            class="btn btn-outline-danger btn-sm">🗑️</a>
        </td>
        <td class="company-name">{{ f.get("company_name", "未設定") }}</td>
        <td>
          {% if f.get('url_top') and f.get('url_top') != '#' %}
            <a href="{{ f['url_top'] }}" target="_blank">
              {% if f.get('eyecatch_image') %}
                <img src="{{ f['eyecatch_image'].replace('http://', 'https://') }}" alt="アイキャッチ" class="eyecatch-img" style="width: 64px; height: 64px; object-fit: cover;" />
              {% else %}
                🌐 サイトを開く
              {% endif %}
            </a>
          {% else %}
            <span class="empty-data">未設定</span>
          {% endif %}
        </td>
        <td>
          {% if f.get('url_form') and f.get('url_form') != '#' %}
            <a href="{{ f['url_form'] }}" target="_blank">📝 フォームを開く</a>
          {% else %}
            <span class="empty-data">未設定</span>
          {% endif %}
        </td>
        <td>{{ f.get("address", "未設定") }}</td>
        <td>{{ f.get("tel", "未設定") }}</td>
        <td>{{ f.get("fax", "未設定") }}</td>
        <td class="category-tag">{{ f.get("category_keywords", "未設定") }}</td>
        <td>{{ f.get("description", "未設定") }}</td>
        <td class="sales-status">{{ f.get("sales_status", "未連絡") }}</td>
        <td>{{ f.get("sales_note", "") }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- 編集モーダル -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form method="POST" action="/update_company">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">✏️ 企業情報を編集</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="company_id" id="edit_id">
          <div class="mb-2"><label>企業名: <input type="text" class="form-control" name="company_name" id="edit_name"></label></div>
          <div class="mb-2"><label>トップページURL: <input type="text" class="form-control" name="url_top" id="edit_url_top"></label></div>
          <div class="mb-2"><label>フォームURL: <input type="text" class="form-control" name="url_form" id="edit_url_form"></label></div>
          <div class="mb-2"><label>住所: <input type="text" class="form-control" name="address" id="edit_address"></label></div>
          <div class="mb-2"><label>電話番号: <input type="text" class="form-control" name="tel" id="edit_tel"></label></div>
          <div class="mb-2"><label>FAX: <input type="text" class="form-control" name="fax" id="edit_fax"></label></div>
          <div class="mb-2"><label>カテゴリ: <input type="text" class="form-control" name="category_keywords" id="edit_category"></label></div>
          <div class="mb-2"><label>説明: <textarea class="form-control" name="description" id="edit_description"></textarea></label></div>
          <div class="mb-2"><label>営業ステータス:
            <select class="form-control" name="sales_status" id="edit_status">
              <option value="未連絡">未連絡</option>
              <option value="連絡済">連絡済</option>
              <option value="保留">保留</option>
            </select>
          </label></div>
          <div class="mb-2"><label>メモ: <textarea class="form-control" name="sales_note" id="edit_note"></textarea></label></div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">保存</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
        </div>
      </div>
    </form>
  </div>
</div>
{% endblock %}

